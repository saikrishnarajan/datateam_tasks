DELIMITER $$
DROP PROCEDURE IF EXISTS SUPPORT-219_UpdatePIIDataForCandidates$$
CREATE PROCEDURE SUPPORT-219_UpdatePIIDataForCandidates()
BEGIN
DECLARE items_remaining int default 0;
/* Count the number of applications before looping */
SELECT COUNT(Id) into items_remaining FROM T_Application Where CompanyId=2154 and DeletedHM=0 and (SentDate <= '2016-11-11') and DeletionDate IS NULL;
/* Loop for every 3000 applications */
chkloop : WHILE (items_remaining>0) DO
/* Update DeletionDate and Modified dates for the given criteria */
update T_Application
set DeletionDate=DATE_ADD(NOW(), INTERVAL 3 HOUR), Modified = now()
where CompanyId=2154 and DeletedHM=0 
and (SentDate <= '2016-11-11') and DeletionDate IS NULL
LIMIT 3000;
/* Refresh the count */
SELECT COUNT(Id) into items_remaining FROM T_Application Where CompanyId=2154 and DeletedHM=0 and (SentDate <= '2016-11-11') and DeletionDate IS NULL;
END WHILE chkloop;  
END$$
DELIMITER ;